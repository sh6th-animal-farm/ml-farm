<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.animalfarm.mlf.domain.carbon.CarbonRepository">

  <!-- 전체 조회 -->
  <select id="selectAll"
          resultType="com.animalfarm.mlf.domain.carbon.dto.CarbonListDTO">
    SELECT
      cp_id               AS cpId,
      project_id          AS projectId,
      cp_type             AS category,
      cp_price            AS cpPrice,
      cp_amount           AS cpAmount,
      product_certificate AS productCertificate,
      vintage_year        AS vintageYear,
      cp_detail           AS cpDetail
    FROM carbon_products
    ORDER BY cp_id DESC
  </select>

  <!-- category 조건 조회 -->
  <select id="selectByCategory"
          parameterType="string"
          resultType="com.animalfarm.mlf.domain.carbon.dto.CarbonListDTO">

    SELECT
      cp_id               AS cpId,
      project_id          AS projectId,
      cp_type             AS category,
      cp_price            AS cpPrice,
      cp_amount           AS cpAmount,
      product_certificate AS productCertificate,
      vintage_year        AS vintageYear,
      cp_detail           AS cpDetail
    FROM carbon_products
    WHERE 1=1

    <if test="category != null and category != '' and category != 'ALL'">
      AND cp_type = #{category}
    </if>

    ORDER BY cp_id DESC
  </select>
  
  <!-- 상세 조회 (해당 탄소 상품 정보)-->
  <select id="selectDetail" resultType="com.animalfarm.mlf.domain.carbon.dto.CarbonDTO">
        SELECT * FROM marifarm.carbon_products WHERE cp_id = #{cpId}
  </select>
   
  <!-- 현재 유저의 지분율이 할인율 정책에 어디 구간인지  -->
  <select id="getDiscountRate" resultType="java.math.BigDecimal">
    SELECT 
        discount_rate_pct 
    FROM 
        marifarm.reduction_sale_policy
    WHERE 
        /* 현재 유저의 지분율이 정책상의 [최소 ~ 최대] 구간 사이에 있는지 확인 */
        #{sharePercent} >= min_ratio_pct 
        AND #{sharePercent} &lt; max_ratio_pct
        /* < 기호 처리 (&lt;): XML 안에서 < 기호를 그대로 쓰면 태그로 오해해서 에러 */
  </select>

</mapper>
