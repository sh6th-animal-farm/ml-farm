<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.animalfarm.mlf.domain.mypage.MypageRepository">
	
	<select id="selectCarbonHistoryByUserId" resultType="com.animalfarm.mlf.domain.mypage.dto.CarbonHistoryDTO">
	    SELECT 
	        cp.cp_type,
	        p.project_name,
	        TO_CHAR(ch.date, 'YYYY. MM. DD') AS date_str,
        	TO_CHAR(ch.date + INTERVAL '1 year', 'YYYY. MM. DD') AS end_date_str,
	        ch.amount,
	        ch.discounted_price AS price
	    FROM carbon_hists ch
	    INNER JOIN carbon_products cp ON ch.cp_id = cp.cp_id
	    INNER JOIN projects p ON cp.project_id = p.project_id
	    WHERE ch.user_id = #{userId}
	    ORDER BY ch.date DESC
	</select>
	
	<select id="getWalletIdByUserId" resultType="long">
        SELECT ucl_id 
        FROM user_certificate_links 
        WHERE user_id = #{userId}
    </select>
    
    
    <insert id="upsertUserWalletLink">
	    INSERT INTO user_certificate_links (
	        ucl_id, 
	        user_id, 
	        certificates_id, 
	        access_token, 
	        refresh_token, 
	        token_expired_at, 
	        refresh_token_expired_at,
	        created_at
	    )
	    VALUES (
	        #{walletId}, 
	        #{userId}, 
	        1, -- 증권사 번호 1 고정
	        #{accessToken}, 
	        #{refreshToken}, 
	        NOW() + INTERVAL '1 hour',
	        NOW() + INTERVAL '30 days',
	        NOW()
	    )
	    ON CONFLICT (user_id) 
	    DO UPDATE SET 
	        ucl_id = EXCLUDED.ucl_id,
	        certificates_id = 1,
	        access_token = EXCLUDED.access_token,
	        refresh_token = EXCLUDED.refresh_token,
	        token_expired_at = EXCLUDED.token_expired_at,
	        refresh_token_expired_at = EXCLUDED.refresh_token_expired_at,
	        updated_at = NOW()
	</insert>
    
    
</mapper>