<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.animalfarm.mlf.domain.mypage.MypageRepository">
	
	<select id="selectCarbonHistoryByUserId" resultType="com.animalfarm.mlf.domain.mypage.dto.CarbonHistoryDTO">
	    SELECT 
	        cp.cp_type,
	        p.project_name,
	        TO_CHAR(ch.date, 'YYYY. MM. DD') AS date_str,
        	TO_CHAR(ch.date + INTERVAL '1 year', 'YYYY. MM. DD') AS end_date_str,
	        ch.amount,
	        ch.discounted_price AS price
	    FROM carbon_hists ch
	    INNER JOIN carbon_products cp ON ch.cp_id = cp.cp_id
	    INNER JOIN projects p ON cp.project_id = p.project_id
	    WHERE ch.user_id = #{userId}
	    ORDER BY ch.date DESC
	</select>
	
	<select id="selectProfile" parameterType="long"
        resultType="com.animalfarm.mlf.domain.mypage.dto.ProfileDTO">
	  SELECT
	  user_name,
	  investor_type,
	  created_at,
	  email,
	  phone_number,
	  address,
	  push_yn,
	  receive_email_yn
	FROM users
	WHERE user_id = #{userId}
	  AND deleted_at IS NULL
	</select>
	
	<update id="updateProfile">
	  UPDATE users
	  <set>
	    <if test="req.address != null">address = #{req.address},</if>
	    <if test="req.pushYn != null">push_yn = #{req.pushYn},</if>
	    <if test="req.receiveEmailYn != null">receive_email_yn = #{req.receiveEmailYn},</if>
	    updated_at = NOW()
	  </set>
	  WHERE user_id = #{userId}
	    AND deleted_at IS NULL
	</update>
	
	<!-- 현재 비밀번호 조회 -->
    <select id="selectPasswordByUserId"
            parameterType="long"
            resultType="string">
        SELECT password
        FROM users
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
    </select>

    <!-- 비밀번호 업데이트 -->
    <update id="updatePassword">
        UPDATE users
        SET password = #{password},
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
    </update>
    
    <select id="selectMyProjects"
    	parameterType="long"
        resultType="com.animalfarm.mlf.domain.mypage.dto.ProjectDTO">

	  SELECT DISTINCT ON (p.project_id)
	    p.project_id,
	    p.project_name,
	    p.project_round,
	    p.project_status,
	
	    p.announcement_start_date,
	    p.announcement_end_date,
	
	    p.subscription_start_date,
	    p.subscription_end_date,
	
	    p.project_start_date,
	    p.project_end_date,
	
	    sh.subscription_status,
	    sp.is_starred
	
	  FROM projects p
	
	  LEFT JOIN subscription_hists sh
	    ON sh.project_id = p.project_id
	   AND sh.user_id = #{user_id}
	   AND sh.deleted_at IS NULL
	
	  LEFT JOIN starred_projects sp
	    ON sp.project_id = p.project_id
	   AND sp.user_id = #{user_id}
	   AND sp.deleted_at IS NULL
	
	  WHERE p.deleted_at IS NULL
	
	  ORDER BY p.project_id, sh.subscription_date DESC
	</select>

	<select id="getWalletIdByUserId" resultType="long">
        SELECT ucl_id 
        FROM user_certificate_links 
        WHERE user_id = #{userId}
    </select>
    
    
    <insert id="upsertUserWalletLink">
	    INSERT INTO user_certificate_links (
	        ucl_id, 
	        user_id, 
	        certificates_id, 
	        access_token, 
	        refresh_token, 
	        token_expired_at, 
	        refresh_token_expired_at,
	        created_at
	    )
	    VALUES (
	        #{walletId}, 
	        #{userId}, 
	        1, -- 증권사 번호 1 고정
	        #{accessToken}, 
	        #{refreshToken}, 
	        NOW() + INTERVAL '1 hour',
	        NOW() + INTERVAL '30 days',
	        NOW()
	    )
	    ON CONFLICT (user_id) 
	    DO UPDATE SET 
	        ucl_id = EXCLUDED.ucl_id,
	        certificates_id = 1,
	        access_token = EXCLUDED.access_token,
	        refresh_token = EXCLUDED.refresh_token,
	        token_expired_at = EXCLUDED.token_expired_at,
	        refresh_token_expired_at = EXCLUDED.refresh_token_expired_at,
	        updated_at = NOW()
	</insert>

</mapper>