    <!-- 나의 프로젝트(기존) -->
    <select id="selectMyProjects"
        parameterType="long"
        resultType="com.animalfarm.mlf.domain.mypage.dto.ProjectDTO">

      SELECT DISTINCT ON (p.project_id)
        p.project_id,
        p.project_name,
        p.project_round,
        p.project_status,

        p.announcement_start_date,
        p.announcement_end_date,

        p.subscription_start_date,
        p.subscription_end_date,

        p.project_start_date,
        p.project_end_date,

        sh.subscription_status,
        sp.is_starred

      FROM projects p

      LEFT JOIN subscription_hists sh
        ON sh.project_id = p.project_id
       AND sh.user_id = #{user_id}
       AND sh.deleted_at IS NULL

      LEFT JOIN starred_projects sp
        ON sp.project_id = p.project_id
       AND sp.user_id = #{user_id}
       AND sp.deleted_at IS NULL

      WHERE p.deleted_at IS NULL

      ORDER BY p.project_id, sh.subscription_date DESC
    </select>

    <!-- 지갑 연동 -->
    <select id="getWalletIdByUserId" resultType="long">
        SELECT ucl_id
        FROM user_certificate_links
        WHERE user_id = #{userId}
    </select>

    <insert id="upsertUserWalletLink">
        INSERT INTO user_certificate_links (
            ucl_id,
            user_id,
            certificates_id,
            access_token,
            refresh_token,
            token_expired_at,
            refresh_token_expired_at,
            created_at
        )
        VALUES (
            #{walletId},
            #{userId},
            1,
            #{accessToken},
            #{refreshToken},
            NOW() + INTERVAL '1 hour',
            NOW() + INTERVAL '30 days',
            NOW()
        )
        ON CONFLICT (user_id)
        DO UPDATE SET
            ucl_id = EXCLUDED.ucl_id,
            certificates_id = 1,
            access_token = EXCLUDED.access_token,
            refresh_token = EXCLUDED.refresh_token,
            token_expired_at = EXCLUDED.token_expired_at,
            refresh_token_expired_at = EXCLUDED.refresh_token_expired_at,
            updated_at = NOW()
    </insert>

    <!-- JOIN 탭: 참여 프로젝트 카드 목록 -->
    <select id="selectJoinedProjectCards" resultType="com.animalfarm.mlf.domain.mypage.dto.ProjectDTO">
      SELECT
        p.project_id      AS projectId,
        p.project_name    AS projectName,
        p.project_status  AS projectStatus,
        sh.subscription_status AS subscriptionStatus,
        p.project_start_date AS projectStartDate,
        p.project_end_date   AS projectEndDate
      FROM projects p
      JOIN subscription_hists sh
        ON sh.project_id = p.project_id
      WHERE sh.user_id = #{userId}
        <if test="status != null and status != 'ALL'">
          AND p.project_status = #{status}
        </if>
      ORDER BY p.project_id DESC
      LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countJoinedProjectCards" resultType="long">
      SELECT COUNT(*)
      FROM projects p
      JOIN subscription_hists sh
        ON sh.project_id = p.project_id
      WHERE sh.user_id = #{userId}
        <if test="status != null and status != 'ALL'">
          AND p.project_status = #{status}
        </if>
    </select>

    <!-- STAR 탭: 관심(찜) 프로젝트 카드 목록 -->
    <select id="selectStarredProjectCards" resultType="com.animalfarm.mlf.domain.mypage.dto.ProjectDTO">
      SELECT
        p.project_id      AS projectId,
        p.project_name    AS projectName,
        p.project_status  AS projectStatus,
        NULL              AS subscriptionStatus,
        p.project_start_date AS projectStartDate,
        p.project_end_date   AS projectEndDate
      FROM projects p
      JOIN starred_projects sp
        ON sp.project_id = p.project_id
      WHERE sp.user_id = #{userId}
        AND sp.is_starred = TRUE
        <if test="status != null and status != 'ALL'">
          AND p.project_status = #{status}
        </if>
      ORDER BY p.project_id DESC
      LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countStarredProjectCards" resultType="long">
      SELECT COUNT(*)
      FROM projects p
      JOIN starred_projects sp
        ON sp.project_id = p.project_id
      WHERE sp.user_id = #{userId}
        AND sp.is_starred = TRUE
        <if test="status != null and status != 'ALL'">
          AND p.project_status = #{status}
        </if>
    </select>

    <!-- 찜 토글 upsert -->
    <insert id="upsertStarredProject">
      INSERT INTO starred_projects (user_id, project_id, is_starred)
      VALUES (#{userId}, #{projectId}, #{starred})
      ON CONFLICT (user_id, project_id)
      DO UPDATE SET is_starred = EXCLUDED.is_starred
    </insert>
